// src/public/dashboard.html - Real-time monitoring dashboard

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice Scam Shield - Real-time Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      .header h1 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 2.5em;
        font-weight: 300;
      }

      .header p {
        color: #7f8c8d;
        font-size: 1.1em;
      }

      .status-bar {
        display: flex;
        gap: 15px;
        margin-top: 15px;
        align-items: center;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 500;
      }

      .status-healthy {
        background: #d4edda;
        color: #155724;
      }

      .status-warning {
        background: #fff3cd;
        color: #856404;
      }

      .status-error {
        background: #f8d7da;
        color: #721c24;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .status-healthy .status-dot {
        background: #28a745;
      }

      .status-warning .status-dot {
        background: #ffc107;
      }

      .status-error .status-dot {
        background: #dc3545;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .metric-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        transition: transform 0.3s ease;
      }

      .metric-card:hover {
        transform: translateY(-5px);
      }

      .metric-title {
        color: #7f8c8d;
        font-size: 0.9em;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
      }

      .metric-value {
        font-size: 2.5em;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .metric-change {
        font-size: 0.9em;
        font-weight: 500;
      }

      .metric-increase {
        color: #e74c3c;
      }

      .metric-decrease {
        color: #27ae60;
      }

      .metric-neutral {
        color: #7f8c8d;
      }

      .charts-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      .chart-title {
        color: #2c3e50;
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 20px;
      }

      .calls-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        margin-bottom: 20px;
      }

      .calls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .calls-title {
        color: #2c3e50;
        font-size: 1.3em;
        font-weight: 600;
      }

      .refresh-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: background 0.3s ease;
      }

      .refresh-btn:hover {
        background: #2980b9;
      }

      .calls-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .calls-table th,
      .calls-table td {
        text-align: left;
        padding: 15px;
        border-bottom: 1px solid #ecf0f1;
      }

      .calls-table th {
        background: #f8f9fa;
        color: #2c3e50;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8em;
        letter-spacing: 1px;
      }

      .risk-badge {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
      }

      .risk-safe {
        background: #d4edda;
        color: #155724;
      }

      .risk-low {
        background: #cce5ff;
        color: #004085;
      }

      .risk-medium {
        background: #fff3cd;
        color: #856404;
      }

      .risk-high {
        background: #f8d7da;
        color: #721c24;
      }

      .risk-critical {
        background: #d1ecf1;
        color: #0c5460;
      }

      .call-row {
        transition: background 0.2s ease;
      }

      .call-row:hover {
        background: #f8f9fa;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .alert {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }

      .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      @media (max-width: 768px) {
        .charts-section {
          grid-template-columns: 1fr;
        }

        .metrics-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .calls-table {
          font-size: 0.9em;
        }

        .calls-table th,
        .calls-table td {
          padding: 10px 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üõ°Ô∏è Voice Scam Shield</h1>
        <p>Real-time monitoring and scam detection dashboard</p>
        <div class="status-bar">
          <div id="systemStatus" class="status-indicator status-healthy">
            <div class="status-dot"></div>
            <span>System Healthy</span>
          </div>
          <div id="connectionStatus" class="status-indicator status-healthy">
            <div class="status-dot"></div>
            <span>Connected</span>
          </div>
          <div id="lastUpdate">
            Last updated: <span id="updateTime">--:--:--</span>
          </div>
        </div>
      </div>

      <div id="alertContainer"></div>

      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-title">Total Calls</div>
          <div class="metric-value" id="totalCalls">-</div>
          <div class="metric-change metric-neutral" id="totalCallsChange">
            No change
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Scams Detected</div>
          <div class="metric-value" id="scamsDetected">-</div>
          <div class="metric-change metric-neutral" id="scamsChange">
            No change
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Active Calls</div>
          <div class="metric-value" id="activeCalls">-</div>
          <div class="metric-change metric-neutral" id="activeChange">
            Currently monitoring
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Detection Accuracy</div>
          <div class="metric-value" id="accuracy">-</div>
          <div class="metric-change metric-neutral" id="accuracyChange">
            Target: >80%
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Response Time</div>
          <div class="metric-value" id="responseTime">-</div>
          <div class="metric-change metric-neutral" id="responseChange">
            Target: <2s
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-title">System Uptime</div>
          <div class="metric-value" id="uptime">-</div>
          <div class="metric-change metric-neutral" id="uptimeChange">
            Running smoothly
          </div>
        </div>
      </div>

      <div class="charts-section">
        <div class="chart-card">
          <div class="chart-title">Call Activity (Last 24 Hours)</div>
          <canvas id="activityChart" width="400" height="200"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Risk Distribution</div>
          <canvas id="riskChart" width="300" height="200"></canvas>
        </div>
      </div>

      <div class="calls-section">
        <div class="calls-header">
          <div class="calls-title">Recent Calls</div>
          <button class="refresh-btn" onclick="refreshCalls()">Refresh</button>
        </div>
        <div id="callsContent">
          <div class="loading">
            <div class="spinner"></div>
            Loading call data...
          </div>
        </div>
      </div>
    </div>

    <script>
      // WebSocket connection
      const socket = io();
      let activityChart, riskChart;
      let lastMetrics = {};

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        initializeCharts();
        connectWebSocket();
        loadInitialData();
      });

      function initializeCharts() {
        // Activity chart
        const activityCtx = document
          .getElementById("activityChart")
          .getContext("2d");
        activityChart = new Chart(activityCtx, {
          type: "line",
          data: {
            labels: generateHourLabels(),
            datasets: [
              {
                label: "Total Calls",
                data: new Array(24).fill(0),
                borderColor: "#3498db",
                backgroundColor: "rgba(52, 152, 219, 0.1)",
                borderWidth: 2,
                fill: true,
              },
              {
                label: "Scam Calls",
                data: new Array(24).fill(0),
                borderColor: "#e74c3c",
                backgroundColor: "rgba(231, 76, 60, 0.1)",
                borderWidth: 2,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });

        // Risk distribution chart
        const riskCtx = document.getElementById("riskChart").getContext("2d");
        riskChart = new Chart(riskCtx, {
          type: "doughnut",
          data: {
            labels: [
              "Safe",
              "Low Risk",
              "Medium Risk",
              "High Risk",
              "Critical",
            ],
            datasets: [
              {
                data: [0, 0, 0, 0, 0],
                backgroundColor: [
                  "#27ae60",
                  "#3498db",
                  "#f39c12",
                  "#e74c3c",
                  "#8e44ad",
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      function connectWebSocket() {
        socket.on("connect", function () {
          updateConnectionStatus("Connected", "healthy");
          console.log("Connected to Voice Scam Shield");
        });

        socket.on("disconnect", function () {
          updateConnectionStatus("Disconnected", "error");
          console.log("Disconnected from Voice Scam Shield");
        });

        socket.on("initialData", function (data) {
          updateMetrics(data.metrics);
          updateActiveCalls(data.activeCalls);
          updateTimestamp();
        });

        socket.on("callStarted", function (data) {
          console.log("New call started:", data);
          refreshActiveCalls();
        });

        socket.on("callCompleted", function (data) {
          console.log("Call completed:", data);
          refreshActiveCalls();
          refreshMetrics();
        });

        socket.on("scamDetected", function (data) {
          console.log("Scam detected:", data);
          showAlert(
            `üö® Scam detected in call ${data.callSid.substr(-8)}`,
            "warning"
          );
          refreshMetrics();
        });

        socket.on("analysisComplete", function (data) {
          console.log("Analysis complete:", data);
          refreshActiveCalls();
        });

        socket.on("updateResponse", function (data) {
          switch (data.type) {
            case "metrics":
              updateMetrics(data.data);
              break;
            case "activeCalls":
              updateActiveCalls(data.data);
              break;
            case "health":
              updateSystemHealth(data.data);
              break;
          }
          updateTimestamp();
        });

        socket.on("error", function (error) {
          console.error("Socket error:", error);
          showAlert(`Connection error: ${error.message}`, "error");
        });
      }

      function loadInitialData() {
        // Request initial data
        socket.emit("requestUpdate", "metrics");
        socket.emit("requestUpdate", "activeCalls");
        socket.emit("requestUpdate", "health");

        // Load call history
        refreshCalls();

        // Load analytics
        refreshAnalytics();
      }

      function updateMetrics(metrics) {
        document.getElementById("totalCalls").textContent =
          metrics.totalCalls || 0;
        document.getElementById("scamsDetected").textContent =
          metrics.scamCallsDetected || 0;
        document.getElementById("activeCalls").textContent =
          metrics.activeCalls || 0;
        document.getElementById("accuracy").textContent =
          `${Math.round((metrics.accuracy || 0) * 100)}%`;
        document.getElementById("responseTime").textContent =
          `${Math.round(metrics.averageResponseTime || 0)}ms`;
        document.getElementById("uptime").textContent = formatUptime(
          metrics.uptime || 0
        );

        // Update changes if we have previous metrics
        if (lastMetrics.totalCalls !== undefined) {
          updateMetricChange(
            "totalCallsChange",
            metrics.totalCalls,
            lastMetrics.totalCalls
          );
          updateMetricChange(
            "scamsChange",
            metrics.scamCallsDetected,
            lastMetrics.scamCallsDetected,
            true
          );
        }

        lastMetrics = metrics;
      }

      function updateMetricChange(
        elementId,
        current,
        previous,
        isIncreaseBad = false
      ) {
        const element = document.getElementById(elementId);
        const change = current - previous;

        if (change > 0) {
          element.textContent = `+${change}`;
          element.className = `metric-change ${isIncreaseBad ? "metric-increase" : "metric-decrease"}`;
        } else if (change < 0) {
          element.textContent = `${change}`;
          element.className = `metric-change ${isIncreaseBad ? "metric-decrease" : "metric-increase"}`;
        } else {
          element.textContent = "No change";
          element.className = "metric-change metric-neutral";
        }
      }

      function updateActiveCalls(calls) {
        // Update active calls count in metrics
        const activeCount = calls.length;
        document.getElementById("activeCalls").textContent = activeCount;

        // Could show active calls in a separate section if needed
      }

      function updateSystemHealth(health) {
        const statusElement = document.getElementById("systemStatus");
        const statusText = statusElement.querySelector("span");

        switch (health.overall) {
          case "healthy":
            statusElement.className = "status-indicator status-healthy";
            statusText.textContent = "System Healthy";
            break;
          case "degraded":
            statusElement.className = "status-indicator status-warning";
            statusText.textContent = "System Degraded";
            break;
          case "unhealthy":
            statusElement.className = "status-indicator status-error";
            statusText.textContent = "System Unhealthy";
            break;
        }
      }

      function updateConnectionStatus(status, type) {
        const statusElement = document.getElementById("connectionStatus");
        const statusText = statusElement.querySelector("span");

        statusElement.className = `status-indicator status-${type}`;
        statusText.textContent = status;
      }

      function refreshMetrics() {
        socket.emit("requestUpdate", "metrics");
      }

      function refreshActiveCalls() {
        socket.emit("requestUpdate", "activeCalls");
      }

      function refreshCalls() {
        const callsContent = document.getElementById("callsContent");
        callsContent.innerHTML =
          '<div class="loading"><div class="spinner"></div>Loading call data...</div>';

        fetch("/api/calls/history?limit=20")
          .then((response) => response.json())
          .then((data) => {
            displayCalls(data.calls);
          })
          .catch((error) => {
            console.error("Error loading calls:", error);
            callsContent.innerHTML =
              '<div class="alert alert-error">Failed to load call data</div>';
          });
      }

      function refreshAnalytics() {
        fetch("/api/analytics?period=24h")
          .then((response) => response.json())
          .then((data) => {
            updateCharts(data.analytics);
          })
          .catch((error) => {
            console.error("Error loading analytics:", error);
          });
      }

      function displayCalls(calls) {
        const callsContent = document.getElementById("callsContent");

        if (!calls || calls.length === 0) {
          callsContent.innerHTML =
            '<div class="empty-state">No recent calls to display</div>';
          return;
        }

        let tableHTML = `
                <table class="calls-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Duration</th>
                            <th>Risk Level</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        calls.forEach((call) => {
          const time = new Date(call.startTime).toLocaleTimeString();
          const duration = call.duration ? formatDuration(call.duration) : "--";
          const riskClass = `risk-${call.riskAssessment.level.toLowerCase()}`;

          tableHTML += `
                    <tr class="call-row">
                        <td>${time}</td>
                        <td>${call.from}</td>
                        <td>${call.to}</td>
                        <td>${duration}</td>
                        <td><span class="risk-badge ${riskClass}">${call.riskAssessment.level}</span></td>
                        <td>${call.status}</td>
                    </tr>
                `;
        });

        tableHTML += "</tbody></table>";
        callsContent.innerHTML = tableHTML;
      }

      function updateCharts(analytics) {
        // Update activity chart
        if (analytics.hourlyBreakdown) {
          const hours = Object.keys(analytics.hourlyBreakdown).sort(
            (a, b) => a - b
          );
          const totalData = hours.map(
            (hour) => analytics.hourlyBreakdown[hour].total || 0
          );
          const scamData = hours.map(
            (hour) => analytics.hourlyBreakdown[hour].scam || 0
          );

          activityChart.data.datasets[0].data = totalData;
          activityChart.data.datasets[1].data = scamData;
          activityChart.update();
        }

        // Update risk distribution chart
        if (analytics.riskDistribution) {
          const riskData = [
            analytics.riskDistribution.SAFE || 0,
            analytics.riskDistribution.LOW || 0,
            analytics.riskDistribution.MEDIUM || 0,
            analytics.riskDistribution.HIGH || 0,
            analytics.riskDistribution.CRITICAL || 0,
          ];

          riskChart.data.datasets[0].data = riskData;
          riskChart.update();
        }
      }

      function showAlert(message, type = "warning") {
        const alertContainer = document.getElementById("alertContainer");
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;

        alertContainer.appendChild(alertDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }

      function updateTimestamp() {
        const now = new Date();
        document.getElementById("updateTime").textContent =
          now.toLocaleTimeString();
      }

      function formatUptime(ms) {
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return `${days}d ${hours % 24}h`;
        if (hours > 0) return `${hours}h ${minutes % 60}m`;
        return `${minutes}m ${seconds % 60}s`;
      }

      function formatDuration(ms) {
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);

        if (minutes > 0) {
          return `${minutes}m ${seconds % 60}s`;
        }
        return `${seconds}s`;
      }

      function generateHourLabels() {
        const labels = [];
        const now = new Date();

        for (let i = 23; i >= 0; i--) {
          const hour = new Date(now - i * 60 * 60 * 1000);
          labels.push(hour.getHours().toString().padStart(2, "0") + ":00");
        }

        return labels;
      }

      // Auto-refresh data every 30 seconds
      setInterval(() => {
        refreshMetrics();
        refreshActiveCalls();
      }, 30000);

      // Auto-refresh analytics every 5 minutes
      setInterval(() => {
        refreshAnalytics();
      }, 300000);
    </script>
  </body>
</html>
